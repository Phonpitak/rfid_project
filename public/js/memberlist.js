// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Sidebar
const sideBar = document.querySelector("aside"); // ‡∏î‡∏∂‡∏á Sidebar
const toggle = document.getElementById("toggle"); // ‡∏î‡∏∂‡∏á‡∏õ‡∏∏‡πà‡∏° Toggle
const logo = document.querySelector(".logo"); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà


toggle.addEventListener("click", function (e) {
    if (sideBar.classList.contains("mini")) {
      sideBar.classList.remove("mini");
      sideBar.style.width = "14rem"; // ‡∏Ç‡∏¢‡∏≤‡∏¢ Sidebar
      
    } else {
      sideBar.classList.add("mini");
      sideBar.style.width = "4rem";  // ‡∏¢‡πà‡∏≠ Sidebar
      
    }
  });
  
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  let menuItems = document.querySelectorAll(".link ul li");
  
  menuItems.forEach(item => {
    item.addEventListener("click", function() {
      // ‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ 'active' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      menuItems.forEach(menu => menu.classList.remove("active"));
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ 'active' ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
      this.classList.add("active");
  
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const link = this.querySelector("a").getAttribute("href");
      window.location.href = link; // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    });
  });
  $(document).ready(function () {
    if (typeof TB_Open === "function") {
      TB_Open();
    } else {
      console.error("Error: TB_Open() ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ thickbox.js ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà");
    }
  });

  $(document).ready(function () {
    var group_id = sessionStorage.getItem("Group");

    if (!group_id) {
        location.href = "login.html";
        return; 
    }

   
    if (group_id == 9) {
        TB_Open();
    } else if (group_id == 1 || group_id == 2) {
        $('#registerMenu').remove(); 
        $('#memberlist').remove();  
        $('#addsubject').remove();
        $('#register_all').remove();
        $('#year_1').remove();
        $('#year_2').remove();
        $('#year_3').remove();
        $('#year_4').remove();
    } else if (group_id == 5) {
        $('#registerMenu').remove(); 
        $('#register_all').remove();
        $('#memberlist').remove();  
        $('#addsubject').remove();
        $('#detailMenu').remove();
        $('#subjectMenu').remove();
        $('#attendanceMenu').remove();

        TB_Open(); 
    }
});

// Modal
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("editModal").style.display = "none";
});

// Search
$(document).ready(function() {
    $("#search_custom").on("keyup", function() {
        var searchText = $(this).val().toLowerCase();
        
        $("#memberlist tr").each(function() {
            var rowText = $(this).text().toLowerCase(); // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            if (rowText.indexOf(searchText) > -1) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
});

$(document).ready(function () {
    ShowUserData();
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
$('#editUserForm').on('submit', async function (e) {
    e.preventDefault();
    let userData = {
        user_id: $('#edit_user_id').val(),
        std_firstname: $('#edit_std_firstname').val(),
        std_lastname: $('#edit_std_lastname').val(),
        b_branch: $('#edit_b_branch').val(),
        f_facully: $('#edit_f_facully').val()
    };

    try {
        const response = await fetch("/member/update", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData)
        });

        if (response.ok) {
            Swal.fire({
                title: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
                icon: "success",
                confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
            }).then(() => {
                closeModal();
                ShowUserData();
            });
        } else {
            Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
        }
    } catch (error) {
        console.error("Error during update:", error);
        Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ", "error");
    }
});

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
function ShowUserData() {
    $.ajax({
        type: "GET",
        url: "/user/memberlist",
        success: function (data) {
            $('#memberlist').empty();
            data.forEach(function (user) {
                const row = `
                    <tr>
                        <td>${user.user_id}</td>
                        <td>${user.std_firstname} ${user.std_lastname}</td>
                        <td>${user.b_branch}</td>
                        <td>${user.f_facully}</td>
                        <td><button class="edit-btn" onclick="editUser('${user.user_id}')">‚úèÔ∏è</button></td>
                        <td><button class="delete-btn" onclick="deleteUser('${user.user_id}')">üóëÔ∏è</button></td>
                    </tr>`;
                $('#memberlist').append(row);
            });
        },
        error: function () {
            Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
        }
    });
}

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal
function editUser(userId) {
    $.ajax({
        type: "GET",
        url: "/member/" + userId,
        success: function (data) {
            $('#edit_user_id').val(data.user_id);
            $('#edit_std_firstname').val(data.std_firstname);
            $('#edit_std_lastname').val(data.std_lastname);
            $('#edit_b_branch').val(data.b_branch);
            $('#edit_f_facully').val(data.f_facully);
            $('#editModal').show();
        },
        error: function () {
            Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ", "error");
        }
    });
}

// ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
function deleteUser(userId) {
    Swal.fire({
        title: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
        text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ ID: " + userId + " ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            fetch("/member/delete/" + userId, { method: "DELETE" })
                .then(response => {
                    if (response.ok) {
                        Swal.fire({
                            title: "‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
                            text: "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
                            icon: "success",
                            confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
                        }).then(() => {
                            ShowUserData();
                        });
                    } else {
                        Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ", "error");
                    }
                })
                .catch(error => {
                    console.error("Error during delete:", error);
                    Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ", "error");
                });
        }
    });
}

// ‡∏õ‡∏¥‡∏î Modal
function closeModal() {
    $('#editModal').hide();
}


// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
$(document).ready(function () {
    ShowUserData();
});
function Logout() {
    sessionStorage.clear();
  }
  function TB_Open() {
    console.log("TB_Open function called!");
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
}


// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å sessionStorage
const firstName = sessionStorage.getItem('Firstname');
const lastName = sessionStorage.getItem('Lastname');
if (firstName && lastName) {
    document.getElementById('profile-name').innerText = `${firstName} ${lastName}`;
} else {
    console.log('No profile data found in sessionStorage');
}

$(document).ready(function() {
    $("#search_TH").on("keyup", function() {
        var searchText = $(this).val().toLowerCase();
        
        $("#memberlist tr").each(function() {
            var id = $(this).find("td:eq(0)").text().toLowerCase();
            var name = $(this).find("td:eq(1)").text().toLowerCase();
            var branch = $(this).find("td:eq(2)").text().toLowerCase();
            var faculty = $(this).find("td:eq(3)").text().toLowerCase();
            
            if (id.indexOf(searchText) > -1 || 
                name.indexOf(searchText) > -1 || 
                branch.indexOf(searchText) > -1 || 
                faculty.indexOf(searchText) > -1) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
});